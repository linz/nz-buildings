name: Run tests
on: push
jobs:
  tests:
    runs-on: ubuntu-18.04
    strategy:
      fail-fast: false
      matrix:
        db_image: [ 'nz-buildings-db-legacy:v1', 'nz-buildings-db-modern:v1' ]
    env:
      PGHOST: localhost
      PGPORT: 5432
      PGUSER: github
      PGPASSWORD: github
      PGDATABASE: github
      SQITCH_VERSION: 1.2.1
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Spawn database container
        run: |
          docker run \
          --name db \
          -p $PGPORT:5432 \
          --volume ${{ github.workspace }}:/nz-buildings \
          --health-cmd pg_isready \
          --health-interval 10s \
          --health-timeout 5s \
          --health-retries 5 \
          -e "PGHOST=$PGHOST" \
          -e "PGPORT=$PGPORT" \
          -e "PGUSER=$PGUSER" \
          -e "PGPASSWORD=$PGPASSWORD" \
          -e "PGDATABASE=$PGDATABASE" \
          -e "POSTGRES_USER=$PGUSER" \
          -e "POSTGRES_PASSWORD=$PGPASSWORD" \
          -e "POSTGRES_DB=$PGDATABASE" \
          -d \
          ghcr.io/linz/${{ matrix.db_image }}
          sleep 30;
      - name: Print docker logs
        uses: jwalton/gh-docker-logs@v1
      - name: Setup database
        run: |
          docker exec -u postgres db psql -a -f /nz-buildings/db/tests/testdata/create_test_admin_bdys_schema.sql
          docker exec -u postgres db psql -a -f /nz-buildings/db/tests/testdata/db/admin_bdys.sql
          docker exec -u postgres db psql -a -f /nz-buildings/db/tests/testdata/create_test_aerial_schema.sql
          docker exec -u postgres db psql -a -f /nz-buildings/db/tests/testdata/db/aerial_lds.sql
      - name: Sqitch deploy
        run: docker exec --workdir /nz-buildings/db/sql db sqitch deploy --verify
      - name: Sqitch revert
        run: docker exec --workdir /nz-buildings/db/sql db sqitch revert -y
        working-directory: ./db/sql
      - name: Sqitch deploy again
        run: docker exec --workdir /nz-buildings/db/sql db sqitch deploy
        working-directory: ./db/sql
      - name: Add test data
        run: |
          docker exec -u postgres db psql -a -f /nz-buildings/db/tests/testdata/db/buildings_reference.sql
          docker exec -u postgres db psql -a -f /nz-buildings/db/tests/testdata/db/buildings_common.sql
          docker exec -u postgres db psql -a -f /nz-buildings/db/tests/testdata/db/buildings.sql
          docker exec -u postgres db psql -a -f /nz-buildings/db/tests/testdata/db/buildings_bulk_load.sql
          docker exec -u postgres db psql -a -f /nz-buildings/db/tests/testdata/db/buildings_lds.sql
          docker exec -u postgres db psql -a -f /nz-buildings/db/tests/testdata/db/update_sequences.sql
          docker exec -u postgres db psql -c 'REFRESH MATERIALIZED VIEW buildings_reference.territorial_authority_grid;' 
      - name: Run pgTAP tests
        run: docker exec db pg_prove /nz-buildings/db/tests
